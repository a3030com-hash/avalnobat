{% extends 'booking/base.html' %}
{% load booking_filters %}

{% block title %}{{ page_title }} - AvalNobat{% endblock %}

{% block content %}
<div class="expense-container">
    {% include 'booking/secretary_payments_content.html' %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const container = document.querySelector('.main-content');

    container.addEventListener('submit', function(e) {
        // Use event delegation to catch submit events on the form,
        // even after the content is reloaded via AJAX.
        if (e.target && e.target.id === 'expense-form') {
            e.preventDefault(); // Prevent default form submission

            const form = e.target;
            const formData = new FormData(form);

            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // The best way to refresh the content is to re-trigger the date navigation's
                    // AJAX call. This ensures all totals and lists are updated correctly.
                    // We can simulate a "no-change" navigation to force a refresh.
                    const currentDateLink = document.querySelector('#secretary-payments-link');
                    if (currentDateLink && currentDateLink.href) {
                        const mainContent = document.querySelector('.main-content');
                        mainContent.style.opacity = '0.5';
                        fetch(currentDateLink.href, {
                            headers: { 'X-Requested-With': 'XMLHttpRequest' }
                        })
                        .then(res => res.text())
                        .then(html => {
                            mainContent.innerHTML = html;
                            mainContent.style.opacity = '1';
                        });
                    }
                } else {
                     alert('خطا در ثبت اطلاعات. لطفاً ورودی‌ها را بررسی کنید.');
                     console.error(data.errors);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
            });
        }
    });
});
</script>
{% endblock %}
