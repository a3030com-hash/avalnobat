{% extends 'booking/base.html' %}
{% load booking_filters %}

{% block title %}{{ page_title }} - AvalNobat{% endblock %}

{% block content %}
<div class="expense-container" id="secretary-payments-container">
    {% include 'booking/secretary_payments_content.html' %}
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('secretary-payments-container');

    // Apply formatting on initial load
    applyNumberFormatting('#secretary-payments-container');

    // Re-apply formatting when new content is loaded via AJAX
    if (container) {
        container.addEventListener('custom:contentUpdated', function() {
            applyNumberFormatting('#secretary-payments-container');
        });
    }

    // Handle form submissions via AJAX, using event delegation on the container
    container.addEventListener('submit', function(e) {
        if (!e.target.closest('form')) return;
        e.preventDefault();

        const form = e.target;
        const numberInput = form.querySelector('.number-input');

        // Clean number input before submitting
        if (numberInput && numberInput.value) {
            numberInput.value = toEnglishNumbers(numberInput.value).replace(/,/g, '');
        }

        const formData = new FormData(form);

        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Reload content, which will trigger 'custom:contentUpdated' and re-apply formatting
                const currentDate = new Date(localStorage.getItem('userDate'));
                window.updateContentForDate(currentDate, false);
            } else {
                console.error('Validation Error:', data.errors);
                alert('خطا در ثبت اطلاعات. لطفاً ورودی خود را بررسی کنید.');
                // Restore formatting on failed submission for better UX
                if (numberInput && numberInput.value) {
                    numberInput.value = formatNumber(numberInput.value);
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An unexpected error occurred.');
            // Restore formatting on network error
            if (numberInput && numberInput.value) {
                numberInput.value = formatNumber(numberInput.value);
            }
        });
    });
});
</script>
{% endblock %}
