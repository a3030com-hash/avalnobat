{% extends 'booking/base.html' %}
{% load booking_filters %}

{% block title %}{{ page_title }} - AvalNobat{% endblock %}

{% block content %}
<div class="expense-container" id="secretary-payments-container">
    {% include 'booking/secretary_payments_content.html' %}
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('secretary-payments-container');
    let userDate;

    function initializeDate() {
        const savedDate = localStorage.getItem('userDate');
        const initialDate = container.querySelector('#date-display') ? new Date('{{ today|date:"Y-m-d" }}') : new Date();
        userDate = savedDate ? new Date(savedDate) : initialDate;
        updateContentForDate(userDate, false);
    }

    async function updateContentForDate(date, pushState = true) {
        const urlDate = date.toISOString().split('T')[0];
        localStorage.setItem('userDate', urlDate);

        const targetUrl = `{% url 'booking:secretary_payments' '0000-00-00' %}`.replace('0000-00-00', urlDate);

        try {
            container.style.opacity = '0.5';
            const response = await fetch(targetUrl, {
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            });
            if (!response.ok) throw new Error('Server response not OK');

            const html = await response.text();
            if (pushState) {
                history.pushState({ path: targetUrl }, '', targetUrl);
            }
            container.innerHTML = html;
        } catch (error) {
            console.error('Fetch error:', error);
            window.location.href = targetUrl; // Fallback
        } finally {
            container.style.opacity = '1';
        }
    }

    container.addEventListener('click', function(e) {
        if (e.target.closest('#prev-day-btn')) {
            userDate.setDate(userDate.getDate() - 1);
            updateContentForDate(userDate);
        }
        if (e.target.closest('#next-day-btn')) {
            userDate.setDate(userDate.getDate() + 1);
            updateContentForDate(userDate);
        }
    });

    container.addEventListener('submit', function(e) {
        if (e.target && e.target.id === 'expense-form') {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);

            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateContentForDate(userDate, false); // Refresh content
                } else {
                     alert('خطا در ثبت اطلاعات. لطفاً ورودی‌ها را بررسی کنید.');
                }
            })
            .catch(error => console.error('Error:', error));
        }
    });

    window.addEventListener('popstate', (event) => {
        if (event.state && event.state.path) {
            const url = new URL(event.state.path, window.location.origin);
            const dateFromPath = url.pathname.split('/').filter(Boolean).pop();
            if (dateFromPath) {
                 userDate = new Date(dateFromPath);
                 updateContentForDate(userDate, false);
            }
        }
    });

    initializeDate();
});
</script>
{% endblock %}
