{% load booking_filters %}
<div id="dynamic-content" data-current-date="{{ today|date:"Y-m-d" }}">
<h2 class="elegant-title">{{ page_title }}</h2>
<div style="text-align:left; margin-bottom: 1rem;">
    <a href="{% url 'booking:expense_balance_report' %}" class="btn-submit">تراز هزینه</a>
    <a  href="{% url 'booking:financial_report' period='daily' date=today|date:'Y-m-d' %}" style="margin-right:auto; " class="btn-submit">گزارش مالی</a>
</div>
<div class="date-navigation local-date-nav" style="display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 1rem;">
    <button id="prev-day-btn" title="روز قبل" class="btn-date-nav">
        <i class="fas fa-chevron-right"></i>
    </button>
    <span id="date-display" style="font-weight: bold; font-size: 1.2rem; color: var(--primary-color);">{{ today|to_jalali:"%A, %d %B %Y" }}</span>
    <button id="next-day-btn" title="روز بعد" class="btn-date-nav">
        <i class="fas fa-chevron-left"></i>
    </button>
</div>
<div class="split-layout">
    <div class="form-container">
        <h3>ثبت هزینه/پرداخت جدید</h3>
        <form style="display: flex; flex-wrap: wrap; gap: 10px; background: #dff8ed;" id="expense-form" method="post" action="{% url 'booking:secretary_payments' date=today|date:'Y-m-d' %}">
            {% csrf_token %}
            <label for="id_description">{{ expense_form.description.label }}</label>
            {{ expense_form.description }}

            <label for="id_amount">{{ expense_form.amount.label }}</label>
            {{ expense_form.amount }}
        
            <button type="submit"  style="text-align:right;" class="btn-submit">ثبت</button>
         </form>
         <script>
            function toEnglishNumbers(str) {
                const persian = ['۰', '۱', '۲', '۳', '۴', '۵', '۶', '۷', '۸', '۹'];
                const arabic = ['٠', '١', '٢', '٣', '٤', '٥', '٦', '٧', '٨', '٩'];
                let result = String(str);
                for (let i = 0; i < 10; i++) {
                    result = result.replace(new RegExp(persian[i], 'g'), i).replace(new RegExp(arabic[i], 'g'), i);
                }
                return result;
            }

            function formatNumber(input) {
                let value = toEnglishNumbers(input.value);
                value = value.replace(/,/g, '').replace(/[^\d.-]/g, '');

                // Limit to 10 digits
                let plainNumber = value.replace(/[.-]/g, '');
                if (plainNumber.length > 10) {
                    value = value.slice(0, 11);
                }

                if (isNaN(parseFloat(value)) && value !== '' && value !== '-') {
                    input.value = '';
                    return;
                }

                let parts = value.split('.');
                let integerPart = parts[0];
                let decimalPart = parts.length > 1 ? '.' + parts[1] : '';
                
                let isNegative = integerPart.startsWith('-');
                if(isNegative) {
                    integerPart = integerPart.substring(1);
                }

                let formattedInteger = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ',');

                input.value = (isNegative ? '-' : '') + formattedInteger + decimalPart;
            }

            document.addEventListener('submit', function(e) {
                if (e.target && e.target.id === 'expense-form') {
                    const amountInput = document.getElementById('id_amount');
                    if (amountInput) {
                        amountInput.value = toEnglishNumbers(amountInput.value).replace(/,/g, '');
                    }
                }
            });
        </script>
        <h6 style="color: brown;">وجه نقدی دریافتی از پزشک را منفی وارد کنید</h6>
    </div>
    <div class="expense-list-container">
        <h3>لیست هزینه‌ها و پرداخت‌های امروز</h3>
     
        <table id="expenses-table" class="report-table">
            <thead>
                <tr>
                    <th>شرح</th>
                    <th>مبلغ (به تومان)</th>
                    <th>عملیات</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td data-label="شرح">مانده صندوق از روز قبل</td>
                    <td data-label="مبلغ (به تومان)">{{ previous_day_balance|intcomma }}</td>
                    <td data-label="عملیات"></td>
                </tr>
                <tr>
                    <td data-label="شرح">اضافه میشود ویزیت های نقدی امروز</td>
                    <td data-label="مبلغ (به تومان)">{{ todays_cash_income|intcomma }}</td>
                    <td data-label="عملیات"></td>
                </tr>
                <tr>
                    <td data-label="شرح">کسر میشود هزینه و پرداختهای امروز:</td>
                    <td data-label="مبلغ (به تومان)"></td>
                    <td data-label="عملیات"></td>
                </tr>
                {% for expense in daily_expenses %}
                <tr>
                    <td data-label="شرح">{{ expense.description }}</td>
                    <td data-label="مبلغ (به تومان)" class="amount {% if expense.amount > 0 %}positive{% else %}negative{% endif %}">
                        {{ expense.amount|intcomma }}
                    </td>
                    <td data-label="عملیات">
                        <a href="{% url 'booking:edit_expense' pk=expense.pk %}" class="btn btn-sm btn-info">ویرایش</a>
                        <a href="{% url 'booking:delete_expense' pk=expense.pk %}" class="btn btn-sm btn-danger">حذف</a>
                    </td>
                </tr>
                {% empty %}
                <tr id="no-expense-row">
                    <td colspan="3">موردی برای نمایش وجود ندارد.</td>
                </tr>
                {% endfor %}
                <tr>
                    <td data-label="شرح">مانده صندوق</td>
                    <td data-label="مبلغ (به تومان)">{{ cash_box_balance|intcomma }}</td>
                    <td data-label="عملیات"></td>
                </tr>
            </tbody>
        </table>
    </div>
  
</div>
</div>