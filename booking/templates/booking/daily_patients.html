{% extends 'booking/base.html' %}
{% load booking_filters %}

{% block title %}{{ page_title }} - AvalNobat{% endblock %}

{% block content %}
<div class="panel-container" id="daily-patients-container">
    {# The initial content is loaded by the view #}
    {% include 'booking/daily_patients_content.html' %}
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('daily-patients-container');

    // Apply formatting on initial load
    applyNumberFormatting('#daily-patients-container');

    // Re-apply formatting when new content is loaded via AJAX
    if (container) {
        container.addEventListener('custom:contentUpdated', function() {
            applyNumberFormatting('#daily-patients-container');
        });
    }

    // Handle form submissions via AJAX, using event delegation on the container
    container.addEventListener('submit', function(e) {
        if (!e.target.closest('form')) return;
        e.preventDefault();

        const form = e.target;
        const numberInputs = form.querySelectorAll('.number-input');

        // Clean number inputs before submitting
        numberInputs.forEach(function(input) {
            if (input.value) {
                input.value = toEnglishNumbers(input.value).replace(/,/g, '');
            }
        });

        const formData = new FormData(form);

        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('تغییرات با موفقیت ذخیره شد.');
                // Reload content, which will trigger 'custom:contentUpdated' and re-apply formatting
                const currentDate = new Date(localStorage.getItem('userDate'));
                window.updateContentForDate(currentDate, false);
            } else {
                console.error('Validation Error:', data.errors);
                alert('خطا در ذخیره اطلاعات. لطفاً ورودی خود را بررسی کنید.');
                // Restore formatting on failed submission for better UX
                numberInputs.forEach(input => {
                    if (input.value) {
                       input.value = formatNumber(input.value);
                    }
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An unexpected error occurred.');
            // Restore formatting on network error
            numberInputs.forEach(input => {
                if (input.value) {
                    input.value = formatNumber(input.value);
                }
            });
        });
    });
});
</script>
{% endblock %}
