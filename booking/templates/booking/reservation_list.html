{% extends 'booking/base.html' %}
{% load static %}
{% load booking_filters %}

{% block title %}{{ page_title }} - AvalNobat{% endblock %}

{% block extra_css %}
<link rel="stylesheet" type="text/css" href="{% static 'booking/css/custom.css' %}">
<style>
    /* اضافه کردن استایل hidden در صورت عدم وجود */
    .hidden {
        display: none !important;
    }
    
    /* استایل‌های اضافی برای اطمینان */
    .cancel-confirmation {
        display: flex;
        gap: 10px;
        align-items: center;
    }
    
    .btn-cancel-initial {
        background-color: #f44336;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 3px;
        cursor: pointer;
    }
    
    .btn-confirm-yes {
        background-color: #4CAF50;
        color: white;
        border: none;
        padding: 5px 15px;
        border-radius: 3px;
        cursor: pointer;
    }
    
    .btn-confirm-no {
        background-color: #ff9800;
        color: white;
        border: none;
        padding: 5px 15px;
        border-radius: 3px;
        cursor: pointer;
    }
</style>
{% endblock %}

{% block content %}
<div class="panel-container">
    <h2 class="elegant-title">{{ page_title }}</h2>
    <div class="alert alert-info" style="text-align: center; margin-bottom: 1rem; background-color: #e7f3fe; color: #089e53; border: 1px solid #bce8f1; padding: 15px; border-radius: 4px;">
         برای  ثبت نوبت جدید به صورت دستی در یک روز خاص، روی ردیف مورد نظر در جدول زیر کلیک کنید.
    </div>
    <div style="text-align:left; margin-bottom: 1rem;">
        <a href="{% url 'booking:daily_patients' %}" class="btn-submit">لیست بیماران امروز</a>
    </div>

    <table class="report-table">
        <thead>
            <tr>
                <th>ردیف</th>
                <th>تاریخ</th>
                <th>روز</th>
                <th>ساعت</th>
                <th>نام و نام خانوادگی</th>
                <th>شماره موبایل</th>
                <th>عملیات</th>
            </tr>
        </thead>
        <tbody>
            {% if grouped_reservations %}
                {% for group in grouped_reservations %}
                    {% for reservation in group.reservations %}
                        <tr style="background-color: {{ group.color }}; cursor: pointer;" class="clickable-row" data-url="{% url 'booking:manage_day' date=group.date|to_jalali:'%Y-%m-%d' %}">
                            <td data-label="ردیف">{{ forloop.counter }}</td>
                            <td data-label="تاریخ">{{ group.date|to_jalali_date }}</td>
                            <td data-label="روز">{{ group.date|to_persian_weekday }}</td>
                            <td data-label="ساعت">{{ reservation.appointment_datetime|time:"H:i" }}</td>
                            <td data-label="نام و نام خانوادگی">{{ reservation.patient_name }}</td>
                            <td data-label="شماره موبایل">{{ reservation.patient_phone }}</td>
                            <td data-label="عملیات">
                                <button class="btn-cancel-initial">لغو نوبت</button>
                                <div class="cancel-confirmation hidden">
                                    <form action="{% url 'booking:cancel_reservation' reservation.pk %}" method="post" style="display:inline;">
                                        {% csrf_token %}
                                        <button type="submit" class="btn-confirm-yes">بله</button>
                                    </form>
                                    <button class="btn-confirm-no">خیر</button>
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="7" style="text-align:center;">هیچ رزروی برای آینده ثبت نشده است.</td>
                </tr>
            {% endif %}
        </tbody>
    </table>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // اول مطمئن شویم همه confirmations مخفی هستند
    document.querySelectorAll('.cancel-confirmation').forEach(div => {
        div.style.display = 'none';
        div.classList.add('hidden');
    });
    
    // Handle clickable rows
    document.querySelectorAll('.clickable-row').forEach(row => {
        row.addEventListener('click', function(event) {
            if (event.target.closest('td[data-label="عملیات"]') || 
                event.target.closest('.cancel-confirmation') ||
                event.target.closest('.btn-cancel-initial')) {
                return;
            }
            const url = this.dataset.url;
            if (url) {
                window.location.href = url;
            }
        });
    });

    // Event delegation for the whole table
    const table = document.querySelector('.report-table');
    if (!table) return;

    table.addEventListener('click', function(event) {
        const target = event.target;

        if (target.classList.contains('btn-cancel-initial')) {
            event.stopPropagation();
            event.preventDefault();
            
            // مخفی کردن همه دکمه‌های دیگر
            table.querySelectorAll('.cancel-confirmation').forEach(div => {
                div.style.display = 'none';
                div.classList.add('hidden');
            });
            
            table.querySelectorAll('.btn-cancel-initial').forEach(btn => {
                btn.style.display = 'inline-block';
            });

            // نمایش confirmation مربوطه
            const confirmationDiv = target.nextElementSibling;
            if (confirmationDiv && confirmationDiv.classList.contains('cancel-confirmation')) {
                target.style.display = 'none';
                confirmationDiv.style.display = 'flex';
                confirmationDiv.classList.remove('hidden');
            }
            
        } else if (target.classList.contains('btn-confirm-no')) {
            event.stopPropagation();
            event.preventDefault();
            
            const confirmationDiv = target.closest('.cancel-confirmation');
            if (confirmationDiv) {
                confirmationDiv.style.display = 'none';
                confirmationDiv.classList.add('hidden');
                
                const initialButton = confirmationDiv.previousElementSibling;
                if (initialButton && initialButton.classList.contains('btn-cancel-initial')) {
                    initialButton.style.display = 'inline-block';
                }
            }
        }
    });
});
</script>
{% endblock %}