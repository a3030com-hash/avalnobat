{% load booking_filters %}
<style>
    .status-completed {
        background-color: rgb(193 233 231) !important;
    }
    .patient-name-toggle {
        cursor: pointer;
        color: #007bff;
        text-decoration: underline;
    }
    .history-row {
        background-color: #f8f9fa;
    }
    .history-container {
        padding: 15px;
    }
    .history-log {
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #ddd;
        padding: 10px;
        margin-bottom: 10px;
        background-color: white;
    }
    .history-entry {
        border-bottom: 1px solid #eee;
        padding-bottom: 5px;
        margin-bottom: 5px;
    }
    .history-date {
        font-weight: bold;
        color: #555;
    }
    .history-text {
        color: #333; /* Patient description color */
    }
    .doctor-note {
        color: #d9534f; /* Doctor note color */
    }
    .problem-description-textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        resize: vertical;
    }
</style>
<div id="dynamic-content" data-current-date="{{ today|date:"Y-m-d" }}">

<h2 class="elegant-title">{{ page_title }}</h2>
<div style="text-align:left; margin-bottom: 1rem;">
    <a href="{% url 'booking:secretary_panel' %}" class="btn-submit" >نوبت‌دهی توسط منشی</a>
    <a href="{% url 'booking:reservation_list' %}" class="btn-submit">لیست رزو</a>
    <a href="{% url 'booking:patient_list' %}" class="btn-submit">لیست کل بیماران</a>
 </div>
<div class="date-navigation local-date-nav" style="display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 1rem;">
    <button id="prev-day-btn" title="روز قبل" class="btn-date-nav">
        <i class="fas fa-chevron-right"></i>
    </button>
    <span id="date-display" style="font-weight: bold; font-size: 1.2rem; color: var(--primary-color);">{{ today|to_jalali:"%A, %d %B %Y" }}</span>
    <button id="next-day-btn" title="روز بعد" class="btn-date-nav">
        <i class="fas fa-chevron-left"></i>
    </button>
</div>
<form id="daily-patients-form" method="post" action="{% url 'booking:daily_patients' date=today|date:'Y-m-d' %}">
    {% csrf_token %}
    {{ formset.management_form }}
    <table class="form-table report-table">
        <thead>
            <tr>
                <th>ساعت</th>
                <th>نام بیمار</th>
                <th>کد ملی</th>
                <th>نوع بیمه</th>
                <th>مبلغ دریافتی</th>
                <th>شرح خدمات</th>
                <th>نحوه پرداخت</th>
            </tr>
        </thead>
        <tbody>
            {% for form in formset %}
                <tr class="{% if form.instance.status > 1 %}status-completed{% endif %}">
                    <td data-label="ساعت">{{ form.instance.appointment_datetime|time:"H:i" }}</td>
                    <td data-label="نام بیمار">
                        {% if user.user_type == 'DOCTOR' %}
                            <span class="patient-name-toggle" data-target="#history-{{ form.instance.id }}">{{ form.instance.patient_name }}</span>
                        {% else %}
                            {{ form.instance.patient_name }}
                        {% endif %}
                    </td>
                    <td data-label="کد ملی">{{ form.instance.patient_national_id|default:"-" }}</td>
                    <td data-label="نوع بیمه">{{ form.insurance_type }}</td>
                    <td data-label="مبلغ دریافتی">{{ form.visit_fee_paid }}</td>
                    <td data-label="شرح خدمات">{{ form.service_description }}</td>
                    <td data-label="نحوه پرداخت">{{ form.payment_method }}</td>
                    {{ form.id }}
                </tr>
                {% if user.user_type == 'DOCTOR' %}
                    {% include 'booking/_patient_history_row.html' %}
                {% endif %}
            {% endfor %}
        </tbody>
    </table>
</form>
</div>

<script>
    function toEnglishNumbers(str) {
        const persian = ['۰', '۱', '۲', '۳', '۴', '۵', '۶', '۷', '۸', '۹'];
        const arabic = ['٠', '١', '٢', '٣', '٤', '٥', '٦', '٧', '٨', '٩'];
        let result = String(str);
        for (let i = 0; i < 10; i++) {
            result = result.replace(new RegExp(persian[i], 'g'), i).replace(new RegExp(arabic[i], 'g'), i);
        }
        return result;
    }

    function formatNumber(input) {
        let value = toEnglishNumbers(input.value);
        value = value.replace(/,/g, '').replace(/[^\d.-]/g, '');

        if (isNaN(parseFloat(value)) && value !== '' && value !== '-') {
            input.value = '';
            return;
        }

        let parts = value.split('.');
        let integerPart = parts[0];
        let decimalPart = parts.length > 1 ? '.' + parts[1] : '';

        let isNegative = integerPart.startsWith('-');
        if(isNegative) {
            integerPart = integerPart.substring(1);
        }

        let formattedInteger = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ',');

        input.value = (isNegative ? '-' : '') + formattedInteger + decimalPart;
    }

    function initializeDailyPatientsListeners() {
        document.querySelectorAll('.patient-name-toggle').forEach(toggle => {
            toggle.addEventListener('click', function() {
                const targetId = this.dataset.target;
                const targetRow = document.querySelector(targetId);
                if (targetRow) {
                    targetRow.style.display = targetRow.style.display === 'none' ? 'table-row' : 'none';
                    if (targetRow.style.display !== 'none') {
                        const historyLog = targetRow.querySelector('.history-log');
                        const textarea = targetRow.querySelector('.problem-description-textarea');
                        if (historyLog && textarea) {
                            const historyHeight = historyLog.offsetHeight;
                            textarea.style.height = (historyHeight + 50) + 'px';
                        }
                    }
                }
            });
        });

        document.querySelectorAll('.problem-description-textarea').forEach(textarea => {
            textarea.addEventListener('focus', function() {
                if (!this.value.includes("---DOCTOR'S NOTE---")) {
                    this.value += "\n---DOCTOR'S NOTE---\n";
                }
            });
        });

        const form = document.getElementById('daily-patients-form');
        if (!form) return;

        let timeout = null;
        let isSaving = false;

        // Ensure the save function is globally accessible but defined within this scope
        window.saveDailyPatientsForm = function() {
            return new Promise((resolve, reject) => {
                if (isSaving) {
                    const checkInterval = setInterval(() => {
                        if (!isSaving) {
                            clearInterval(checkInterval);
                            resolve();
                        }
                    }, 100);
                    return;
                }
                clearTimeout(timeout);
                isSaving = true;
                const formData = new FormData(form);
                const url = form.action;
                form.querySelectorAll('.number-input').forEach(input => {
                    const fieldName = input.name;
                    const rawValue = input.value;
                    if (rawValue) {
                        const cleanedValue = toEnglishNumbers(rawValue).replace(/,/g, '');
                        formData.set(fieldName, cleanedValue);
                    }
                });
                fetch(url, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': '{{ csrf_token }}'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('Form saved!');
                        resolve();
                    } else {
                        console.error('Save Error:', data.errors);
                        reject(data.errors);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    reject(error);
                })
                .finally(() => {
                    isSaving = false;
                });
            });
        };

        form.addEventListener('input', function(e) {
            clearTimeout(timeout);
            timeout = setTimeout(window.saveDailyPatientsForm, 500);
        });

        form.addEventListener('submit', function(e) {
            const numberInputs = e.target.querySelectorAll('.number-input');
            numberInputs.forEach(function(input) {
                if (input.value) {
                    input.value = toEnglishNumbers(input.value).replace(/,/g, '');
                }
            });
        });
    }

    // Run the initialization for the initial load.
    // DOMContentLoaded might be too early if this template is loaded via AJAX.
    // So we just call it directly.
    initializeDailyPatientsListeners();
</script>
