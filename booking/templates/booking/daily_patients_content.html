{% load booking_filters %}
<div id="dynamic-content" data-current-date="{{ today|date:"Y-m-d" }}">

<h1>{{ page_title }}</h1>

<div class="date-navigation local-date-nav" style="display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 1rem;">
    <button id="prev-day-btn" title="روز قبل" class="btn-date-nav">
        <i class="fas fa-chevron-right"></i>
    </button>
    <span id="date-display" style="font-weight: bold; font-size: 1.2rem; color: var(--primary-color);">{{ today|to_jalali:"%A, %d %B %Y" }}</span>
    <button id="next-day-btn" title="روز بعد" class="btn-date-nav">
        <i class="fas fa-chevron-left"></i>
    </button>
</div>

<form id="daily-patients-form" method="post" action="{% url 'booking:daily_patients' date=today|date:'Y-m-d' %}">
    {% csrf_token %}
    {{ formset.management_form }}
    <table class="form-table report-table">
        <thead>
            <tr>
                <th>ساعت</th>
                <th>نام بیمار</th>
                <th>کد ملی</th>
                <th>نوع بیمه</th>
                <th>مبلغ دریافتی</th>
                <th>شرح خدمات</th>
                <th>نحوه پرداخت</th>
            </tr>
        </thead>
        <tbody>
            {% for form in formset %}
                <tr>
                    <td data-label="ساعت">{{ form.instance.appointment_datetime|time:"H:i" }}</td>
                    <td data-label="نام بیمار">{{ form.instance.patient_name }}</td>
                    <td data-label="کد ملی">{{ form.instance.patient_national_id|default:"-" }}</td>
                    <td data-label="نوع بیمه">{{ form.insurance_type }}</td>
                    <td data-label="مبلغ دریافتی">
                        <input type="text" name="{{ form.visit_fee_paid.name }}" class="number-input" 
                               value="{{ form.visit_fee_paid.value|default:"0"|comma }}" 
                               oninput="formatNumber(this)">
                    </td>
                    <td data-label="شرح خدمات">{{ form.service_description }}</td>
                    <td data-label="نحوه پرداخت">{{ form.payment_method }}</td>
                    {{ form.id }}
                </tr>
            {% endfor %}
        </tbody>
    </table>
    <button type="submit" name="update_appointments" class="btn-submit">ذخیره تغییرات نوبت‌ها</button>
</form>
</div>

<script>
    function formatNumber(input) {
        // 1. Get the value and remove any existing commas.
        let value = input.value.replace(/,/g, '').replace(/[^0-9.]/g, '');
        
        // 2. Ensure it's a valid number, otherwise clear the input.
        if (isNaN(value) || value === '' || value === null) {
            input.value = '';
            return;
        }
        
        // 3. Convert to number to remove leading zeros, then back to string.
        let numValue = parseFloat(value);

        // 4. Use a regex to add thousand separators.
        let formattedValue = numValue.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');

        input.value = formattedValue;
    }
</script>