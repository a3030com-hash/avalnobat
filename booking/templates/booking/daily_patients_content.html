{% load booking_filters %}
<style>
    .status-completed {
        background-color: rgb(193 233 231) !important;
    }
    .patient-name-toggle {
        cursor: pointer;
        color: #007bff;
        text-decoration: underline;
    }
    .history-row {
        background-color: #f8f9fa;
    }
    .history-container {
        padding: 15px;
    }
    .history-log {
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #ddd;
        padding: 10px;
        margin-bottom: 10px;
        background-color: white;
    }
    .history-entry {
        border-bottom: 1px solid #eee;
        padding-bottom: 5px;
        margin-bottom: 5px;
    }
    .history-date {
        font-weight: bold;
        color: #555;
    }
    .history-text {
        color: #333; /* Patient description color */
    }
    .doctor-note {
        color: #d9534f; /* Doctor note color */
    }
    .problem-description-textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        resize: vertical;
    }
</style>
<div id="dynamic-content" data-current-date="{{ today|date:"Y-m-d" }}">

<h2 class="elegant-title">{{ page_title }}</h2>
<div style="text-align:left; margin-bottom: 1rem;">
    <a href="{% url 'booking:secretary_panel' %}" class="btn-submit" >نوبت‌دهی توسط منشی</a>
    <a href="{% url 'booking:reservation_list' %}" class="btn-submit">لیست رزو</a>
    <a href="{% url 'booking:patient_list' %}" class="btn-submit">لیست کل بیماران</a>
 </div>
<div class="date-navigation local-date-nav" style="display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 1rem;">
    <button id="prev-day-btn" title="روز قبل" class="btn-date-nav">
        <i class="fas fa-chevron-right"></i>
    </button>
    <span id="date-display" style="font-weight: bold; font-size: 1.2rem; color: var(--primary-color);">{{ today|to_jalali:"%A, %d %B %Y" }}</span>
    <button id="next-day-btn" title="روز بعد" class="btn-date-nav">
        <i class="fas fa-chevron-left"></i>
    </button>
</div>
<form id="daily-patients-form" method="post" action="{% url 'booking:daily_patients' date=today|date:'Y-m-d' %}">
    {% csrf_token %}
    {{ formset.management_form }}
    <table class="form-table report-table">
        <thead>
            <tr>
                <th>ساعت</th>
                <th>نام بیمار</th>
                <th>کد ملی</th>
                <th>نوع بیمه</th>
                <th>مبلغ دریافتی</th>
                <th>شرح خدمات</th>
                <th>نحوه پرداخت</th>
            </tr>
        </thead>
        <tbody>
            {% for form in formset %}
                <tr class="{% if form.instance.status > 1 %}status-completed{% endif %}">
                    <td data-label="ساعت">{{ form.instance.appointment_datetime|time:"H:i" }}</td>
                    <td data-label="نام بیمار">
                        {% if user.user_type == 'DOCTOR' %}
                            <span class="patient-name-toggle" data-target="#history-{{ form.instance.id }}">{{ form.instance.patient_name }}</span>
                        {% else %}
                            {{ form.instance.patient_name }}
                        {% endif %}
                    </td>
                    <td data-label="کد ملی">{{ form.instance.patient_national_id|default:"-" }}</td>
                    <td data-label="نوع بیمه">{{ form.insurance_type }}</td>
                    <td data-label="مبلغ دریافتی">{{ form.visit_fee_paid }}</td>
                    <td data-label="شرح خدمات">{{ form.service_description }}</td>
                    <td data-label="نحوه پرداخت">{{ form.payment_method }}</td>
                    {{ form.id }}
                </tr>
                {% if user.user_type == 'DOCTOR' %}
                    {% include 'booking/_patient_history_row.html' %}
                {% endif %}
            {% endfor %}
        </tbody>
    </table>
</form>
</div>
