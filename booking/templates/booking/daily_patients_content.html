{% load booking_filters %}
<style>
    .status-completed {
        background-color: rgb(193 233 231) !important;
    }
</style>
<div id="dynamic-content" data-current-date="{{ today|date:"Y-m-d" }}">

<h2 class="elegant-title">{{ page_title }}</h2>
<div style="text-align:left; margin-bottom: 1rem;">
    <a href="{% url 'booking:secretary_panel' %}" class="btn-submit" >نوبت‌دهی توسط منشی</a>
    <a href="{% url 'booking:reservation_list' %}" class="btn-submit">لیست رزو</a>
    <a href="{% url 'booking:patient_list' %}" class="btn-submit">لیست کل بیماران</a>
 </div>
<div class="date-navigation local-date-nav" style="display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 1rem;">
    <button id="prev-day-btn" title="روز قبل" class="btn-date-nav">
        <i class="fas fa-chevron-right"></i>
    </button>
    <span id="date-display" style="font-weight: bold; font-size: 1.2rem; color: var(--primary-color);">{{ today|to_jalali:"%A, %d %B %Y" }}</span>
    <button id="next-day-btn" title="روز بعد" class="btn-date-nav">
        <i class="fas fa-chevron-left"></i>
    </button>
</div>
<form id="daily-patients-form" method="post" action="{% url 'booking:daily_patients' date=today|date:'Y-m-d' %}">
    {% csrf_token %}
    {{ formset.management_form }}
    <table class="form-table report-table">
        <thead>
            <tr>
                <th>ساعت</th>
                <th>نام بیمار</th>
                <th>کد ملی</th>
                <th>نوع بیمه</th>
                <th>مبلغ دریافتی</th>
                <th>شرح خدمات</th>
                <th>نحوه پرداخت</th>
            </tr>
        </thead>
        <tbody>
            {% for form in formset %}
                <tr class="{% if form.instance.status > 1 %}status-completed{% endif %}">
                    <td data-label="ساعت">{{ form.instance.appointment_datetime|time:"H:i" }}</td>
                    <td data-label="نام بیمار">{{ form.instance.patient_name }}</td>
                    <td data-label="کد ملی">{{ form.instance.patient_national_id|default:"-" }}</td>
                    <td data-label="نوع بیمه">{{ form.insurance_type }}</td>
                    <td data-label="مبلغ دریافتی">{{ form.visit_fee_paid }}</td>
                    <td data-label="شرح خدمات">{{ form.service_description }}</td>
                    <td data-label="نحوه پرداخت">{{ form.payment_method }}</td>
                    {{ form.id }}
                </tr>
            {% endfor %}
        </tbody>
    </table>
</form>
</div>

<script>
    function toEnglishNumbers(str) {
        const persian = ['۰', '۱', '۲', '۳', '۴', '۵', '۶', '۷', '۸', '۹'];
        const arabic = ['٠', '١', '٢', '٣', '٤', '٥', '٦', '٧', '٨', '٩'];
        let result = String(str);
        for (let i = 0; i < 10; i++) {
            result = result.replace(new RegExp(persian[i], 'g'), i).replace(new RegExp(arabic[i], 'g'), i);
        }
        return result;
    }

    function formatNumber(input) {
        let value = toEnglishNumbers(input.value);
        value = value.replace(/,/g, '').replace(/[^\d.-]/g, '');

        if (isNaN(parseFloat(value)) && value !== '' && value !== '-') {
            input.value = '';
            return;
        }

        let parts = value.split('.');
        let integerPart = parts[0];
        let decimalPart = parts.length > 1 ? '.' + parts[1] : '';

        let isNegative = integerPart.startsWith('-');
        if(isNegative) {
            integerPart = integerPart.substring(1);
        }

        let formattedInteger = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ',');

        input.value = (isNegative ? '-' : '') + formattedInteger + decimalPart;
    }

    document.addEventListener('submit', function(e) {
        if (e.target && e.target.id === 'daily-patients-form') {
            const numberInputs = e.target.querySelectorAll('.number-input');
            numberInputs.forEach(function(input) {
                if (input.value) {
                    input.value = toEnglishNumbers(input.value).replace(/,/g, '');
                }
            });
        }
    });

    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('daily-patients-form');
        if (!form) return;

        let timeout = null;

        form.addEventListener('input', function(e) {
            clearTimeout(timeout);
            timeout = setTimeout(() => {
                const formData = new FormData(form);
                const url = form.action;

                // Clean number inputs before sending
                form.querySelectorAll('.number-input').forEach(input => {
                    const fieldName = input.name;
                    const rawValue = input.value;
                    if (rawValue) {
                        const cleanedValue = toEnglishNumbers(rawValue).replace(/,/g, '');
                        formData.set(fieldName, cleanedValue);
                    }
                });

                fetch(url, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': '{{ csrf_token }}'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Maybe show a subtle success indicator
                        console.log('Autosaved!');
                    } else {
                        console.error('Autosave Error:', data.errors);
                        // Optionally, display an error message to the user
                    }
                })
                .catch(error => console.error('Error:', error));
            }, 500); // Debounce time in ms
        });
    });
</script>
