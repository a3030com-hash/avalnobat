{% extends 'booking/base.html' %}
{% load booking_filters %}

{% block title %}{{ page_title }} - AvalNobat{% endblock %}

{% block content %}
<div class="panel-container">
    <h1>{{ page_title }}</h1>

    <div class="search-container" style="margin-bottom: 20px; text-align: center;">
        <form method="get" action="{% url 'booking:patient_list' %}" id="search-form">
            <div style="position: relative; display: inline-block; width: 40%;">
                <input type="text" name="q" placeholder="جستجو بر اساس نام، کد ملی، شماره همراه..." value="{{ search_query }}" class="search-input" style="width: 100%; padding-left: 30px;">
                <span class="clear-search" id="clear-search-btn" style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; display: {% if search_query %}inline{% else %}none{% endif %};">&times;</span>
            </div>
            <button type="submit" class="btn-submit">جستجو</button>
        </form>
    </div>

    <table class="report-table">
        <thead>
            <tr>
                <th>ردیف</th>
                <th>نام و نام خانوادگی</th>
                <th>تاریخ ویزیت</th>
                <th>ساعت ویزیت</th>
                <th>کد ملی</th>
                <th>شماره همراه</th>
            </tr>
        </thead>
        <tbody>
            {% for app in appointments %}
                <tr class="clickable-row" data-href="{% url 'booking:daily_patients' date=app.appointment_datetime|date:'Y-m-d' %}">
                    <td data-label="ردیف">{{ forloop.counter }}</td>
                    <td data-label="نام و نام خانوادگی">{{ app.patient_name }}</td>
                    <td data-label="تاریخ ویزیت">{{ app.appointment_datetime|to_jalali_date }}</td>
                    <td data-label="ساعت ویزیت">{{ app.appointment_datetime|time:"H:i" }}</td>
                    <td data-label="کد ملی">{{ app.patient_national_id|default:"-" }}</td>
                    <td data-label="شماره همراه">{{ app.patient_phone }}</td>
                </tr>
            {% empty %}
                <tr>
                    <td colspan="6" style="text-align: center;">هیچ بیماری یافت نشد.</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle clickable rows
    const rows = document.querySelectorAll('.clickable-row');
    rows.forEach(row => {
        row.addEventListener('click', () => {
            window.location.href = row.dataset.href;
        });
    });

    // Handle search clear button
    const searchInput = document.querySelector('.search-input');
    const clearBtn = document.getElementById('clear-search-btn');
    const searchForm = document.getElementById('search-form');

    searchInput.addEventListener('input', function() {
        clearBtn.style.display = this.value ? 'inline' : 'none';
    });

    clearBtn.addEventListener('click', function() {
        searchInput.value = '';
        clearBtn.style.display = 'none';
        searchForm.submit();
    });
});
</script>
{% endblock %}
