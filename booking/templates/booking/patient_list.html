{% extends 'booking/base.html' %}
{% load booking_filters %}

{% block title %}{{ page_title }} - AvalNobat{% endblock %}

{% block content %}
<div class="panel-container">
    <div style="position: relative;">
        <h2 class="elegant-title">{{ page_title }}</h2>
        <a href="{% url 'booking:doctor_list' %}" class="home-icon-link" title="صفحه اصلی">
            <i class="fas fa-home"></i>
        </a>
    </div>

    <div class="search-container" style="margin-bottom: 20px; text-align: center;">
        <form method="get" action="{% url 'booking:patient_list' %}" id="search-form" style="display: flex; justify-content: center; align-items: center;">
            <div style="position: relative; display: inline-block; flex-grow: 1; max-width: 250px; margin-right: 5px;"> <!-- تنظیم عرض باکس -->
                <input type="text" name="q" placeholder="جستجو بر اساس نام، کد ملی، شماره همراه، شرح خدمات..." value="{{ search_query }}" class="search-input" style="width: 100%; padding-left: 30px; height: 40px;">
                <span class="clear-search" id="clear-search-btn" style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; display: {% if search_query %}inline{% else %}none{% endif %};">&times;</span>
            </div>
            <button type="submit" class="btn-submit" style="padding: 10px 15px; height: 40px;transform: translateX(-55%);">جستجو</button> <!-- دکمه جستجو -->
        </form>
    </div>

    <div class="export-buttons" style="text-align: center; margin-bottom: 20px;">
        <a href="{% url 'booking:export_patients_to_excel' %}" class="btn-submit">
            <i class="fas fa-file-excel"></i> اکسل
        </a>
        <button id="copy-patients-btn" class="btn-submit">
            <i class="fas fa-copy"></i> کپی
        </button>
    </div>
    <table class="report-table" id="patients-table">
        <thead>
            <tr>
                <th>ردیف</th>
                <th>نام و نام خانوادگی</th>
                <th>تاریخ ویزیت</th>
                <th>ساعت ویزیت</th>
                <th>کد ملی</th>
                <th>شماره همراه</th>
                <th>شرح خدمات</th>
            </tr>
        </thead>
        <tbody>
            {% for app in appointments %}
                <tr class="clickable-row" data-href="{% url 'booking:daily_patients' date=app.appointment_datetime|date:'Y-m-d' %}">
                    <td data-label="ردیف">{{ forloop.counter }}</td>
                    <td data-label="نام و نام خانوادگی">{{ app.patient_name }}</td>
                    <td data-label="تاریخ ویزیت">{{ app.appointment_datetime|to_jalali_date }}</td>
                    <td data-label="ساعت ویزیت">{{ app.appointment_datetime|time:"H:i" }}</td>
                    <td data-label="کد ملی">{{ app.patient_national_id|default:"-" }}</td>
                    <td data-label="شماره همراه">{{ app.patient_phone }}</td>
                    <td data-label="شرح خدمات">{{ app.service_description }}</td>
                </tr>
            {% empty %}
                <tr>
                    <td colspan="7" style="text-align: center;">هیچ بیماری یافت نشد.</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle clickable rows
    const rows = document.querySelectorAll('.clickable-row');
    rows.forEach(row => {
        row.addEventListener('click', () => {
            window.location.href = row.dataset.href;
        });
    });

    // Handle search clear button
    const searchInput = document.querySelector('.search-input');
    const clearBtn = document.getElementById('clear-search-btn');
    const searchForm = document.getElementById('search-form');

    searchInput.addEventListener('input', function() {
        clearBtn.style.display = this.value ? 'inline' : 'none';
    });

    clearBtn.addEventListener('click', function() {
        searchInput.value = '';
        clearBtn.style.display = 'none';
        searchForm.submit();
    });

    // Handle copy to clipboard
    const copyBtn = document.getElementById('copy-patients-btn');
    copyBtn.addEventListener('click', function() {
        const table = document.getElementById('patients-table');

        // Create the HTML content with styles
        const styles = `
            <style>
                table { border-collapse: collapse; width: 100%; font-family: sans-serif; direction: rtl; }
                th, td { border: 1px solid #dddddd; text-align: right; padding: 8px; }
                thead th { background-color: #f2f2f2; }
                tr:nth-child(even) { background-color: #f9f9f9; }
            </style>
        `;
        const htmlContent = styles + table.outerHTML;

        // Create a plain text fallback
        let textContent = '';
        table.querySelectorAll('tr').forEach(row => {
            row.querySelectorAll('th, td').forEach(cell => {
                textContent += cell.innerText + '\t';
            });
            textContent += '\n';
        });

        // Use the Clipboard API to write both HTML and plain text
        try {
            const blobHtml = new Blob([htmlContent], { type: 'text/html' });
            const blobText = new Blob([textContent], { type: 'text/plain' });
            const clipboardItem = new ClipboardItem({
                'text/html': blobHtml,
                'text/plain': blobText,
            });

            navigator.clipboard.write([clipboardItem]).then(() => {
                copyBtn.innerHTML = '<i class="fas fa-check"></i> کپی شد';
                setTimeout(() => {
                    copyBtn.innerHTML = '<i class="fas fa-copy"></i> کپی';
                }, 2000);
            });
        } catch (err) {
            console.error('Failed to copy: ', err);
            // Fallback for older browsers
            navigator.clipboard.writeText(textContent).then(() => {
                 copyBtn.innerHTML = '<i class="fas fa-check"></i> کپی شد (متن)';
                setTimeout(() => {
                    copyBtn.innerHTML = '<i class="fas fa-copy"></i> کپی';
                }, 2000);
            });
        }
    });
});
</script>
{% endblock %}